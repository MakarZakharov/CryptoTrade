                # —â–æ–± —Ü—è —à—Ç—É–∫–∞ –ø—Ä–∞—Ü—é–≤–∞–ª–∞ —Ç—Ä–µ–±–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª .env –∑ BINANCE_API_KEY —ñ BINANCE_API_SECRET –≤ —Ç—ñ–π –∂–µ –ø–∞–ø—Ü—ñ —â–æ —ñ —Ü–µ–π
import ccxt
import os
import sys
from dotenv import load_dotenv
import time

USE_TESTNET = False
load_dotenv()

API_KEY = os.getenv('BINANCE_API_KEY')
API_SECRET = os.getenv('BINANCE_API_SECRET')

if not API_KEY or not API_SECRET:
    print("‚ùå –ü–æ–º–∏–ª–∫–∞: API –∫–ª—é—á—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É —Ñ–∞–π–ª—ñ .env.")
    sys.exit("–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∫–ª—é—á—ñ–≤.")


def get_valid_input(prompt, validation_func, error_message):
    while True:
        user_input = input(prompt).strip()
        if validation_func(user_input):
            return user_input
        else:
            print(error_message)

def get_positive_float_input(prompt):
    while True:
        try:
            value = float(input(prompt).strip())
            if value > 0.000001:
                return value
            else:
                print("‚ùå –ß–∏—Å–ª–æ –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ –±—ñ–ª—å—à–µ –Ω—É–ª—è.")
        except ValueError:
            print("‚ùå –ó–∞–º–∞–ª–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å.")


def connect_to_binance(api_key, secret_key, use_testnet):
    print("\nüîÑ –°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Binance...")
    exchange = ccxt.binance({'apiKey': api_key, 'secret': secret_key, 'enableRateLimit': True})
    if use_testnet:
        print("   –£–≤—ñ–º–∫–Ω–µ–Ω–æ —Ä–µ–∂–∏–º –¢–ï–°–¢–û–í–û–á –ú–ï–†–ï–ñ–Ü.")
        exchange.set_sandbox_mode(True)
    try:
        exchange.fetch_time()
        print("   –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è... –û–ö")
        print("   –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–∏–Ω–∫—ñ–≤...")
        exchange.load_markets()
        print(f"‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ! –î–æ—Å—Ç—É–ø–Ω–æ —Ä–∏–Ω–∫—ñ–≤: {len(exchange.markets)}")
        return exchange
    except ccxt.AuthenticationError: print("‚ùå –ü–û–ú–ò–õ–ö–ê –ê–í–¢–ï–ù–¢–ò–§–Ü–ö–ê–¶–Ü–á: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∫–ª—é—á—ñ –∞–±–æ –¥–æ–∑–≤–æ–ª–∏.")
    except ccxt.NetworkError as e: print(f"‚ùå –ü–û–ú–ò–õ–ö–ê –ú–ï–†–ï–ñ–Ü: {e}. {'–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∞—Å!' if '-1021' in str(e) else '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç.'}")
    except Exception as e: print(f"‚ùå –ù–ï–í–Ü–î–û–ú–ê –ü–û–ú–ò–õ–ö–ê –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: {e}")
    print("   –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è.")
    return None


def place_market_order(exchange, symbol, side, amount):
    print(f"   ‚û°Ô∏è –°–ø—Ä–æ–±–∞ {side.upper()} {amount:.8f} {symbol.split('/')[0]} –Ω–∞ **{symbol}**...")
    try:
        order_func = exchange.create_market_buy_order if side == 'buy' else exchange.create_market_sell_order
        order = order_func(symbol, amount)
        print(f"   ‚úÖ –û—Ä–¥–µ—Ä {side.upper()} –Ω–∞ {symbol} —Ä–æ–∑–º—ñ—â–µ–Ω–æ (ID: {order.get('id', 'N/A')})")
        return order
    except ccxt.InsufficientFunds: print(f"   ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤ –¥–ª—è {side} {symbol}.")
    except ccxt.InvalidOrder as e: print(f"   ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –æ—Ä–¥–µ—Ä ({symbol}). –ú—ñ–Ω. —Å—É–º–∞/–∫—ñ–ª—å–∫—ñ—Å—Ç—å? {e}")
    except Exception as e: print(f"   ‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ä–¥–µ—Ä—É {side} {symbol}: {e}")
    return None


def get_approx_conversion_info(exchange, from_currency, to_currency):
    from_curr = from_currency.upper()
    to_curr = to_currency.upper()
    if from_curr == to_curr: return 1.0, f"{from_curr}", None

    markets = exchange.markets
    def _fetch_price(symbol):
        try: return exchange.fetch_ticker(symbol).get('last')
        except Exception: return None

    direct_symbol = f"{from_curr}/{to_curr}"
    price = _fetch_price(direct_symbol)
    if price and price > 0: return price, direct_symbol, None


    inverse_symbol = f"{to_curr}/{from_curr}"
    price = _fetch_price(inverse_symbol)
    if price and price > 0: return 1 / price, f"(via {inverse_symbol})", None

    if from_curr != 'USDT' and to_curr != 'USDT':
        symbol1 = f"{from_curr}/USDT"
        symbol2 = f"{to_curr}/USDT"
        price1 = _fetch_price(symbol1)
        price2 = _fetch_price(symbol2)
        if price1 and price2 and price2 > 0:
            return price1 / price2, "(via USDT)", "USDT"

    return None, None, None


def execute_conversion_by_trade(exchange, amount, from_currency, to_currency, rate, path, intermediary):
    """
    –ó–∞–ø–∏—Ç—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —ñ –≤–∏–∫–æ–Ω—É—î –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—é —à–ª—è—Ö–æ–º —Ä–∏–Ω–∫–æ–≤–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤.
    """
    from_curr = from_currency.upper()
    to_curr = to_currency.upper()
    approx_result = amount * rate

    print(f"\n--- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó (—á–µ—Ä–µ–∑ –ú–∞—Ä–∫–µ—Ç –û—Ä–¥–µ—Ä–∏) ---")
    print(f"   –î—ñ—è: –ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ {amount:.8f} {from_curr} –≤ ~{approx_result:.8f} {to_curr}")
    print(f"   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —à–ª—è—Ö: {path}")
    print(f"   ! –£–≤–∞–≥–∞: –û—Å—Ç–∞—Ç–æ—á–Ω–∞ —Å—É–º–∞ –º–æ–∂–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è —á–µ—Ä–µ–∑ –∫–æ–º—ñ—Å—ñ—ó —Ç–∞ –ø—Ä–æ—Å–ª–∏–∑–∞–Ω–Ω—è —Ü—ñ–Ω–∏.")

    confirm = get_valid_input("   –í–≤–µ–¥—ñ—Ç—å 'yes' –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤: ", lambda x: x.lower() == 'yes', "‚ùå –í–≤–µ–¥—ñ—Ç—å 'yes' –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.")
    if confirm != 'yes':
        print("üö´ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.")
        return

    print("\nüöÄ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó...")

    success = False
    if intermediary is None:
        if "/" in path and "(via" not in path:
            symbol_to_trade = path
            side = 'sell'
            amount_to_trade = amount
            print(f"   (Info: –ü—Ä—è–º–∏–π —Ä–∏–Ω–æ–∫ {symbol_to_trade}. –ü—Ä–æ–¥–∞–∂ {from_curr}...)")
            order = place_market_order(exchange, symbol_to_trade, side, amount_to_trade)
            if order: success = True

        elif "(via " in path:
            inverse_symbol = path.replace("(via ", "").replace(")", "")
            symbol_to_trade = inverse_symbol
            side = 'buy'
            amount_to_trade = approx_result
            print(f"   (Info: –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π —Ä–∏–Ω–æ–∫ {symbol_to_trade}. –ö—É–ø—ñ–≤–ª—è {to_curr}...)")
            order = place_market_order(exchange, symbol_to_trade, side, amount_to_trade)
            if order: success = True
        else:
             print(f"   ‚ùå –ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç —à–ª—è—Ö—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞: {path}")

    elif intermediary == "USDT":
         symbol1 = f"{from_curr}/USDT"
         symbol2 = f"{to_curr}/USDT"
         print(f"\n   –ö—Ä–æ–∫ 1: –ü—Ä–æ–¥–∞–∂ {from_curr} –∑–∞ USDT ({symbol1})...")
         order1 = place_market_order(exchange, symbol1, 'sell', amount)

         if order1 and order1.get('status') != 'canceled':
             time.sleep(1)
             print(f"\n   –ö—Ä–æ–∫ 2: –ö—É–ø—ñ–≤–ª—è {to_curr} –∑–∞ USDT ({symbol2})...")
             amount_to_buy_to = approx_result
             order2 = place_market_order(exchange, symbol2, 'buy', amount_to_buy_to)
             if order2: success = True
         else:
              print(f"   üõë –ö—Ä–æ–∫ 1 (–ü—Ä–æ–¥–∞–∂ {from_curr}) –Ω–µ –≤–¥–∞–≤—Å—è. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ.")
    else:
          print(f"   ‚ùå –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –ø–æ—Å–µ—Ä–µ–¥–Ω–∏–∫–∞ '{intermediary}' –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.")

    if success:
         print("\nüéâ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è (—á–µ—Ä–µ–∑ —Ä–∏–Ω–∫–æ–≤—ñ –æ—Ä–¥–µ—Ä–∏) —É—Å–ø—ñ—à–Ω–∞.")
    else:
         print("\n‚ö†Ô∏è –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è")

def run_bot():
    print("--- Binance_BOT ---")
    exchange = connect_to_binance(API_KEY, API_SECRET, USE_TESTNET)
    if not exchange: sys.exit("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è")
    available_markets = list(exchange.markets.keys())

    while True:
        print("\n--- –ì–æ–ª–æ–≤–Ω–µ –ú–µ–Ω—é ---")
        print("1. –¢–æ—Ä–≥—ñ–≤–ª—è (Market Order)")
        print("2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –í–∞–ª—é—Ç (—á–µ—Ä–µ–∑ Market Order)")
        print("3. –í–∏—Ö—ñ–¥")
        action = get_valid_input("–í–∞—à –≤–∏–±—ñ—Ä (1-3): ", lambda x: x in ['1', '2', '3'], "‚ùå –í–≤–µ–¥—ñ—Ç—å 1, 2 –∞–±–æ 3.")

        if action == '1':
            print("\n--- –¢–æ—Ä–≥—ñ–≤–ª—è ---")
            symbol = get_valid_input(
                "–í–≤–µ–¥—ñ—Ç—å —Å–∏–º–≤–æ–ª –ø–∞—Ä–∏ (–Ω–∞–ø—Ä., BTC/USDT): ",
                lambda s: s.upper() in available_markets,
                "‚ùå –°–∏–º–≤–æ–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç (–ë–ê–ó–ê/–ö–û–¢–ò–†–£–í–ê–ù–ù–Ø)."
            ).upper()
            side = get_valid_input(f"–ö—É–ø–∏—Ç–∏ —á–∏ –ø—Ä–æ–¥–∞—Ç–∏ {symbol.split('/')[0]} (buy/sell): ", lambda s: s.lower() in ['buy', 'sell'], "‚ùå –í–≤–µ–¥—ñ—Ç—å 'buy' –∞–±–æ 'sell'.").lower()
            amount = get_positive_float_input(f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å {symbol.split('/')[0]} –¥–ª—è {side}: ")
            print(f"\nüö¶ –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å {side.upper()} {amount} {symbol.split('/')[0]}?")
            if get_valid_input("   –í–≤–µ–¥—ñ—Ç—å 'yes': ", lambda x: x.lower() == 'yes', "–í–≤–µ–¥—ñ—Ç—å 'yes' –∞–±–æ —Å–∫–∞—Å—É–π—Ç–µ.") == 'yes':
                place_market_order(exchange, symbol, side, amount)
            else:
                print("üö´ –¢–æ—Ä–≥—ñ–≤–ª—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.")


        elif action == '2':
            print("\n--- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è (—á–µ—Ä–µ–∑ –ú–∞—Ä–∫–µ—Ç –û—Ä–¥–µ—Ä–∏) ---")
            amount = get_positive_float_input("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: ")
            from_c = input("–ó —è–∫–æ—ó –≤–∞–ª—é—Ç–∏ (–Ω–∞–ø—Ä., BTC): ").upper().strip()
            to_c = input("–í —è–∫—É –≤–∞–ª—é—Ç—É (–Ω–∞–ø—Ä., USDT): ").upper().strip()

            rate, path, intermediary = get_approx_conversion_info(exchange, from_c, to_c)

            if rate is not None:
                approx_result_display = amount * rate
                print(f"\n   –ü—Ä–∏–±–ª–∏–∑–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫: {amount:.8f} {from_c} ‚âà {approx_result_display:.8f} {to_c}")
                print(f"   –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏–π –∫—É—Ä—Å: {rate:.8f}, –®–ª—è—Ö: {path}")

                execute_conversion_by_trade(exchange, amount, from_c, to_c, rate, path, intermediary)
            else:
                print(f"\n‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ —Å–ø–æ—Å—ñ–± –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó {from_c} –≤ {to_c} –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∫—É—Ä—Å—É.")

        elif action == '3':
            print("\n –í—Å—å–æ")
            break

if __name__ == "__main__":
    run_bot()
